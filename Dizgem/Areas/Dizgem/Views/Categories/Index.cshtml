@{
    ViewData["Title"] = "Kategoriler";
}
@section styles {
    <link href="~/lib/DataTables/datatables.min.css" rel="stylesheet" type="text/css" media="all" />
}

<h3>Kategoriler</h3>

<p>
    @Html.AntiForgeryToken()
    <a asp-action="Create" class="btn btn-primary">Yeni Kategori Oluştur</a>
</p>

<div class="table-responsive">
    <table id="categoriesTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
            <tr>
                <th>Kategori Adı</th>
                <th>URL Metni (Slug)</th>
                <th data-orderable="false" data-searchable="false">İşlemler</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

@section Scripts {
    <script src="~/lib/DataTables/pdfmake-0.1.36/pdfmake.min.js"></script>
    <script src="~/lib/DataTables/pdfmake-0.1.36/vfs_fonts.js"></script>
    <script src="~/lib/DataTables/datatables.min.js"></script>

    <script>
        $(document).ready(function () {
            var dataTable = $('#categoriesTable').DataTable({
                dom: '<"clearfix d-flex justify-content-around mb-3"<"w-100"f>B><"clearfix overflow-auto"t><"px-3 border-0 d-flex flex-column flex-lg-row align-items-center justify-content-between"<li>p>',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        autoFilter: true
                    }
                ],
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "/Dizgem/Categories/LoadCategoriesData",
                    "type": "POST",
                    "datatype": "json"
                },
                "columns": [
                    { "data": "name", "name": "Name" },
                    { "data": "slug", "name": "Slug" },
                    {
                        "data": "id",
                        "render": function (data, type, row) {
                            var editUrl = `/Dizgem/Categories/Edit/${data}`;
                            return `<a href="${editUrl}" class="btn btn-sm btn-info">Düzenle</a> ` +
                                   `<a href="javascript:void(0);" class="btn btn-sm btn-danger delete-btn" data-id="${data}" data-name="${row.name}">Sil</a>`;
                        },
                        "orderable": false,
                        "width": "150px"
                    }
                ],
                "language": { "url": "/lib/DataTables/i18n/tr-TR.json" }
            });

            $('#categoriesTable').on('click', '.delete-btn', function () {
                var categoryId = $(this).data('id');
                var categoryName = $(this).data('name');
                var token = $('input[name="__RequestVerificationToken"]').val();

                Swal.fire({
                    title: 'Emin misiniz?',
                    text: `'${categoryName}' kategorisini silmek üzeresiniz. Bu işlem geri alınamaz!`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Evet, sil!',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/Dizgem/Categories/Delete/${categoryId}`,
                            type: 'POST',
                            headers: { 'RequestVerificationToken': token },
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire('Silindi!', response.message, 'success');
                                    dataTable.ajax.reload();
                                } else {
                                    Swal.fire('Hata!', response.message, 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('Hata!', 'İşlem sırasında bir sunucu hatası oluştu.', 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
}
